<!DOCTYPE HTML>
<html>
<head>
<title>global</title>
<script>
    var responders = {
        applyToAll: function (event) {
            return safari.extension.settings.applyToAll;
        },
        
        toDataURL: function (url) {
            var img = new Image(),
                canvas = document.createElement("canvas"),
                context = canvas.getContext("2d");
            img.src = url;
            canvas.width = img.width;
            canvas.height = img.height;
            context.drawImage(img, 0, 0, img.width, img.height);
            return canvas.toDataURL();
        }
    };
    
    safari.application.addEventListener("message", function (event) {
        var name = event.name,
            message = event.message
            target = event.target.page
            resp = responders[name];
        if (resp) {
            target.dispatchMessage(name, resp(message));
        } else if (name.match(/^toDataURL:/)) {
            target.dispatchMessage(name, responders.toDataURL(message));
        }
    });
</script>
</head>
<body>
</body>
</html>